exports.handler = async (event) => {
    const huggingFaceApiToken = process.env.HUGGING_FACE_API_TOKEN;
    const modelId = "moonshotai/Kimi-K2-Instruct"; // Ensure this model is suitable for conversational AI
    const apiUrl = `https://api-inference.huggingface.co/models/${modelId}`;

    if (event.httpMethod !== "POST") {
        return { statusCode: 405, body: "Method Not Allowed" };
    }

    let userMessage;
    try {
        const body = JSON.parse(event.body);
        userMessage = body.message;
    } catch (error) {
        return { statusCode: 400, body: JSON.stringify({ error: "Invalid request body." }) };
    }

    if (!userMessage) {
        return { statusCode: 400, body: JSON.stringify({ error: "No message provided." }) };
    }

    if (!huggingFaceApiToken) {
        return { statusCode: 500, body: JSON.stringify({ error: "API token missing." }) };
    }

    // Define the AI's persona and knowledge base about the company
    const aiPersonaContext = `
        You are an AI assistant for Asif Digital Marketing, a digital marketing company based in the UAE.
        The company primarily serves businesses in Sharjah, Dubai, Abu Dhabi, Ajman, and Ras Al Khaimah.
        The owner and lead expert is Asif, a freelance digital marketer specializing in AI solutions with over 5 years of experience.

        Asif Digital Marketing offers a comprehensive range of services, including:
        - WhatsApp Chatbots & Automation: 24/7 customer support, automated order processing, instant FAQ responses.
        - Social Media Content & Ads: AI-assisted content creation, targeted ad campaigns for Instagram, Facebook, TikTok, and community engagement.
        - AI-Powered Lead Follow-up: Automated email/SMS sequences, lead nurturing, conversion optimization.
        - Local SEO & Google Ads: Google Business Profile optimization, local keyword targeting, targeted PPC campaigns.
        - AI Content Generation: Automating high-quality content for blogs, social media, and ads.
        - Predictive Analytics & Personalization: Analyzing data, predicting trends, personalizing customer experiences.
        - Intelligent Marketing Automation: Streamlining repetitive tasks, automating email campaigns, optimizing ad bidding.
        - AI-Driven Customer Segmentation: Precise audience segmentation for hyper-targeted messaging.

        Asif's credentials include Google Ads Certified and Meta Blueprint Certified, with a track record of empowering over 10 local businesses.
        The company's focus is on helping local cafes, shops, and startups automate their marketing and elevate their digital presence.
        Contact information: Phone/WhatsApp: +971 54 586 6094, Email: asifk199707@gmail.com, Address: Muwailih Commercial, Sharjah, UAE.

        When responding, act as a helpful and knowledgeable representative of Asif Digital Marketing.
        Always refer to the company as 'Asif Digital Marketing' and to the owner as 'Asif'.
        Answer questions based on the information provided about the company and its services.
    `;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${huggingFaceApiToken}`
            },
            body: JSON.stringify({
                // Prepend the persona context to the user's message
                inputs: aiPersonaContext + "\n\nUser: " + userMessage + "\nAI Assistant:",
                parameters: {
                    max_new_tokens: 200, // Increased token limit for more detailed responses
                    temperature: 0.7,
                    do_sample: true,
                    // Ensure the model doesn't generate too much extra content
                    return_full_text: false // Important for getting only the generated response
                }
            })
        });

        const result = await response.json();

        if (!response.ok) {
            // Log the full error response from Hugging Face for debugging
            console.error("Hugging Face API Error Response:", result);
            return { statusCode: response.status, body: JSON.stringify({ error: result.error || "Hugging Face API error." }) };
        }

        let aiResponseText = "Sorry, I couldn't get a response from the AI.";
        if (Array.isArray(result) && result.length > 0 && result[0].generated_text) {
            // Clean up the generated text to remove the input prompt if it's returned
            aiResponseText = result[0].generated_text.replace(aiPersonaContext + "\n\nUser: " + userMessage + "\nAI Assistant:", "").trim();
            // Further refine by removing any partial sentences or unwanted leading text from the AI
            if (aiResponseText.startsWith("AI Assistant:")) {
                aiResponseText = aiResponseText.substring("AI Assistant:".length).trim();
            }
        } else {
            aiResponseText = "Unexpected AI response format or empty response.";
            console.warn("Unexpected AI response structure:", result);
        }

        return {
            statusCode: 200,
            body: JSON.stringify({ response: aiResponseText }),
        };

    } catch (error) {
        console.error('Error calling Hugging Face API:', error);
        return { statusCode: 500, body: JSON.stringify({ error: "Internal server error." }) };
    }
};
